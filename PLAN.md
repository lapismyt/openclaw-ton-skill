# OpenClaw TON Skill — План разработки

> Версия: 1.0  
> Дата: 2026-02-13  
> Статус: Draft

---

## Архитектура

### Структура файлов

```
openclaw-ton-skill/
├── SKILL.md                 # Описание для агента (команды, примеры)
├── SPEC.md                  # ТЗ
├── PLAN.md                  # Этот план
├── scripts/
│   ├── __init__.py
│   ├── config.py            # Загрузка конфига, API ключи
│   ├── crypto.py            # Шифрование/дешифровка ключей
│   ├── storage.py           # Работа с файлами (кошельки, адресная книга)
│   ├── tonapi.py            # Обёртка TonAPI
│   ├── swapcoffee.py        # Обёртка swap.coffee API
│   ├── dyor.py              # Обёртка DYOR API
│   ├── wallet.py            # CLI: управление кошельками
│   ├── balance.py           # CLI: балансы и мониторинг
│   ├── transfer.py          # CLI: переводы
│   ├── swap.py              # CLI: свапы
│   ├── analytics.py         # CLI: аналитика токенов
│   ├── yield_cmd.py         # CLI: yield/DeFi (yield.py зарезервирован)
│   ├── nft.py               # CLI: NFT операции
│   └── dns.py               # CLI: .ton домены
├── references/              # Документация API
└── tests/                   # Тесты
```

### Разделение ответственности

| Слой | Файлы | Назначение |
|------|-------|------------|
| **Core** | `config.py`, `crypto.py`, `storage.py` | Инфраструктура: конфиг, шифрование, хранение |
| **API** | `tonapi.py`, `swapcoffee.py`, `dyor.py` | Обёртки над внешними API |
| **CLI** | `wallet.py`, `transfer.py`, `swap.py`, ... | Скрипты для вызова агентом |

### Хранение данных

```
~/.openclaw/ton-skill/
├── config.json              # API ключи, настройки
├── wallets.json.enc         # Зашифрованные кошельки
├── addressbook.json         # Адресная книга (не секретно)
└── cache/                   # Кэш (курсы, токены)
```

### Принципы

1. **Один скрипт = один домен** — wallet.py только про кошельки
2. **JSON вывод** — все скрипты возвращают JSON для парсинга агентом
3. **Человекочитаемый режим** — флаг `--human` для красивого вывода
4. **Эмуляция по умолчанию** — транзакции сначала эмулируются
5. **Явное подтверждение** — `--confirm` или интерактивный режим

---

## Фазы разработки

### Phase 0: Инфраструктура (Приоритет: КРИТИЧЕСКИЙ)

**Цель:** Заложить фундамент — конфиг, шифрование, хранение.

| ID | Задача | Зависит от | Файл |
|----|--------|------------|------|
| 0.1 | Структура директорий и __init__.py | — | — |
| 0.2 | Конфиг: загрузка/сохранение API ключей | 0.1 | `config.py` |
| 0.3 | Шифрование AES-256 (encrypt/decrypt) | 0.1 | `crypto.py` |
| 0.4 | Хранилище кошельков (CRUD, зашифровано) | 0.2, 0.3 | `storage.py` |
| 0.5 | Адресная книга (CRUD, plain JSON) | 0.2 | `storage.py` |
| 0.6 | Базовая обёртка TonAPI (init, auth) | 0.2 | `tonapi.py` |

**Критерии готовности:**
- [ ] `config.py` читает/пишет `~/.openclaw/ton-skill/config.json`
- [ ] `crypto.py` шифрует/дешифрует строки с паролем
- [ ] `storage.py` сохраняет/загружает кошельки (зашифрованно)
- [ ] Тесты на шифрование (round-trip)

**Оценка:** 1-2 дня

---

### Phase 1: MVP — Кошельки и переводы (Приоритет: ВЫСОКИЙ)

**Цель:** Минимально рабочий скилл — создать кошелёк, посмотреть баланс, отправить TON.

#### 1A. Управление кошельками

| ID | Задача | Зависит от | Файл |
|----|--------|------------|------|
| 1.1 | Генерация мнемоники (BIP39) | 0.4 | `wallet.py` |
| 1.2 | Импорт кошелька из мнемоники | 0.4 | `wallet.py` |
| 1.3 | Список кошельков (без секретов) | 0.4 | `wallet.py` |
| 1.4 | Удаление кошелька | 0.4 | `wallet.py` |
| 1.5 | Лейблы кошельков | 0.4 | `wallet.py` |
| 1.6 | Экспорт адреса (публичного) | 1.1 | `wallet.py` |

**CLI:**
```bash
wallet.py create --label "trading"
wallet.py import --mnemonic "word1 word2..."
wallet.py list
wallet.py delete --address UQ...
wallet.py rename --address UQ... --label "main"
```

#### 1B. Балансы

| ID | Задача | Зависит от | Файл |
|----|--------|------------|------|
| 1.7 | TonAPI: получение баланса TON | 0.6, 1.3 | `tonapi.py` |
| 1.8 | TonAPI: получение баланса жетонов | 0.6 | `tonapi.py` |
| 1.9 | Баланс кошелька (TON + жетоны + USD) | 1.7, 1.8 | `balance.py` |
| 1.10 | Баланс всех кошельков | 1.9 | `balance.py` |

**CLI:**
```bash
balance.py show --address UQ...
balance.py show --all
```

#### 1C. Переводы TON

| ID | Задача | Зависит от | Файл |
|----|--------|------------|------|
| 1.11 | TonAPI: эмуляция транзакции | 0.6 | `tonapi.py` |
| 1.12 | Формирование transfer payload | 1.1 | `transfer.py` |
| 1.13 | Эмуляция перевода (показ комиссии) | 1.11, 1.12 | `transfer.py` |
| 1.14 | Подписание и отправка транзакции | 1.13 | `transfer.py` |
| 1.15 | Резолв .ton доменов | 0.6 | `dns.py` |

**CLI:**
```bash
transfer.py send --from UQ... --to UQ... --amount 5
transfer.py send --from UQ... --to wallet.ton --amount 5
# → показывает эмуляцию, ждёт --confirm
transfer.py send --from UQ... --to UQ... --amount 5 --confirm
```

**Критерии готовности Phase 1:**
- [ ] Можно создать кошелёк, получить адрес
- [ ] Можно посмотреть баланс (TON + жетоны)
- [ ] Можно отправить TON с эмуляцией и подтверждением
- [ ] .ton домены резолвятся
- [ ] Приватные ключи хранятся зашифрованно

**Оценка:** 3-4 дня

---

### Phase 2: Торговля (Приоритет: ВЫСОКИЙ)

**Цель:** Свапы токенов через swap.coffee.

| ID | Задача | Зависит от | Файл |
|----|--------|------------|------|
| 2.1 | Обёртка swap.coffee API (auth, quote) | 0.2 | `swapcoffee.py` |
| 2.2 | Получение маршрута свапа | 2.1 | `swapcoffee.py` |
| 2.3 | Эмуляция свапа | 2.2, 1.11 | `swap.py` |
| 2.4 | Исполнение свапа | 2.3 | `swap.py` |
| 2.5 | Статус транзакции свапа | 2.1 | `swap.py` |
| 2.6 | Перевод жетонов (Jetton transfer) | 1.14 | `transfer.py` |

**CLI:**
```bash
swap.py quote --from TON --to USDT --amount 10
swap.py execute --from TON --to USDT --amount 10 --wallet UQ...
swap.py status --tx-hash abc123
transfer.py send-jetton --from UQ... --to UQ... --jetton USDT --amount 100
```

**Критерии готовности:**
- [ ] Можно получить котировку свапа
- [ ] Можно исполнить свап с эмуляцией
- [ ] Можно отправить жетоны

**Оценка:** 2-3 дня

---

### Phase 3: Аналитика (Приоритет: СРЕДНИЙ)

**Цель:** Информация о токенах через DYOR API.

| ID | Задача | Зависит от | Файл |
|----|--------|------------|------|
| 3.1 | Обёртка DYOR API | 0.2 | `dyor.py` |
| 3.2 | Информация о токене (цена, mcap, volume) | 3.1 | `analytics.py` |
| 3.3 | Рейтинг доверия (скам-скор) | 3.1 | `analytics.py` |
| 3.4 | История цены | 3.1 | `analytics.py` |
| 3.5 | Пулы токена (DEX) | 3.1 | `analytics.py` |
| 3.6 | Сравнение токенов | 3.2 | `analytics.py` |

**CLI:**
```bash
analytics.py info --token SCALE
analytics.py trust --token SCALE
analytics.py history --token SCALE --days 7
analytics.py pools --token SCALE
analytics.py compare --tokens "SCALE,NOT,STON"
```

**Критерии готовности:**
- [ ] Можно получить информацию о любом токене
- [ ] Скам-скор показывается для токена
- [ ] Агент может оценить "стоит ли покупать"

**Оценка:** 2 дня

---

### Phase 4: Yield/DeFi (Приоритет: СРЕДНИЙ)

**Цель:** Работа с пулами ликвидности через swap.coffee Yield.

| ID | Задача | Зависит от | Файл |
|----|--------|------------|------|
| 4.1 | swap.coffee Yield: список пулов | 2.1 | `swapcoffee.py` |
| 4.2 | Детали пула (APY, TVL, риск) | 4.1 | `yield_cmd.py` |
| 4.3 | Рекомендации пулов по критериям | 4.2 | `yield_cmd.py` |
| 4.4 | Добавление ликвидности | 4.1, 1.14 | `yield_cmd.py` |
| 4.5 | Вывод ликвидности | 4.1, 1.14 | `yield_cmd.py` |
| 4.6 | Позиции пользователя | 4.1 | `yield_cmd.py` |

**CLI:**
```bash
yield_cmd.py pools --sort apy --min-tvl 100000
yield_cmd.py pool --id abc123
yield_cmd.py recommend --token TON --risk low
yield_cmd.py deposit --pool abc123 --amount 100 --wallet UQ...
yield_cmd.py withdraw --pool abc123 --wallet UQ...
yield_cmd.py positions --wallet UQ...
```

**Критерии готовности:**
- [ ] Список пулов с сортировкой
- [ ] Можно добавить/вывести ликвидность
- [ ] Можно видеть свои позиции и PnL

**Оценка:** 3 дня

---

### Phase 5: NFT (Приоритет: НИЗКИЙ)

**Цель:** Просмотр и операции с NFT.

| ID | Задача | Зависит от | Файл |
|----|--------|------------|------|
| 5.1 | TonAPI: NFT в кошельке | 0.6 | `tonapi.py` |
| 5.2 | TonAPI: информация о коллекции | 0.6 | `tonapi.py` |
| 5.3 | Список NFT пользователя | 5.1 | `nft.py` |
| 5.4 | Детали NFT | 5.2 | `nft.py` |
| 5.5 | Трансфер NFT | 1.14, 5.1 | `nft.py` |
| 5.6 | Floor price коллекции | 5.2 | `nft.py` |

**CLI:**
```bash
nft.py list --wallet UQ...
nft.py info --address EQ...
nft.py transfer --nft EQ... --from UQ... --to UQ...
nft.py collection --address EQ...
```

**Критерии готовности:**
- [ ] Можно посмотреть NFT в кошельке
- [ ] Можно передать NFT

**Оценка:** 2 дня

---

### Phase 6: Дополнительно (Приоритет: НИЗКИЙ)

**Цель:** DNS, мониторинг, улучшения.

| ID | Задача | Зависит от | Файл |
|----|--------|------------|------|
| 6.1 | Информация о .ton домене | 1.15 | `dns.py` |
| 6.2 | Мульти-переводы | 1.14 | `transfer.py` |
| 6.3 | Алерты на баланс | 1.9 | `balance.py` |
| 6.4 | История транзакций | 0.6 | `balance.py` |
| 6.5 | Мульти-свап | 2.4 | `swap.py` |

**Оценка:** 2-3 дня

---

## MVP Definition

**Минимальный первый релиз (Phase 0 + Phase 1):**

### Must Have (MVP)
- ✅ Создание/импорт кошелька
- ✅ Шифрование приватных ключей
- ✅ Просмотр баланса (TON + жетоны)
- ✅ Отправка TON с эмуляцией
- ✅ Подтверждение транзакций
- ✅ Резолв .ton доменов

### Should Have (Phase 2)
- Свапы через swap.coffee
- Перевод жетонов

### Could Have (Phase 3-4)
- Аналитика токенов
- Yield пулы

### Won't Have (v1.0)
- Покупка NFT на маркетплейсах
- Покупка доменов
- Подписка на события (webhooks)

---

## Зависимости между фазами

```
Phase 0 (Infra)
    │
    ├──→ Phase 1 (MVP: Wallets + Transfers)
    │         │
    │         ├──→ Phase 2 (Trading)
    │         │         │
    │         │         └──→ Phase 4 (Yield)
    │         │
    │         └──→ Phase 5 (NFT)
    │
    └──→ Phase 3 (Analytics) ←── независимо от Phase 1
```

---

## Риски и митигация

| Риск | Вероятность | Импакт | Митигация |
|------|-------------|--------|-----------|
| API swap.coffee недоступно | Низкая | Высокий | Фолбэк на прямые DEX |
| Ошибка в шифровании | Низкая | Критический | Тесты, code review, проверенные библиотеки |
| Rate limits API | Средняя | Средний | Кэширование, exponential backoff |
| Изменение API | Средняя | Средний | Версионирование, абстракции |

---

## Timeline (ориентировочно)

| Фаза | Оценка | Кумулятивно |
|------|--------|-------------|
| Phase 0 | 1-2 дня | 2 дня |
| Phase 1 (MVP) | 3-4 дня | 6 дней |
| Phase 2 | 2-3 дня | 9 дней |
| Phase 3 | 2 дня | 11 дней |
| Phase 4 | 3 дня | 14 дней |
| Phase 5 | 2 дня | 16 дней |
| Phase 6 | 2-3 дня | 19 дней |

**MVP готов:** ~1 неделя  
**Полный скилл:** ~3 недели

---

## Следующий шаг

1. Создать базовую структуру (`scripts/`, `__init__.py`)
2. Реализовать `config.py` и `crypto.py`
3. Написать тесты на шифрование
4. Начать Phase 1

---

*Обновлять этот план по мере прогресса.*
